<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Fallback Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        #info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>üóÇÔ∏è Storage Fallback System Test</h1>
    
    <div id="info">
        <h3>Diagnostic Information</h3>
        <div id="diagnostic-info">Loading...</div>
    </div>

    <div class="test-section">
        <h3>üìù Write and Read Testing</h3>
        <button onclick="testBasicOperations()">Test Basic Operations</button>
        <div id="basic-test-results"></div>
    </div>

    <div class="test-section">
        <h3>üóÑÔ∏è IndexedDB Fallback Test</h3>
        <p>This test temporarily disables localStorage to verify fallback to IndexedDB</p>
        <button onclick="testLocalStorageFallback()">Test IndexedDB Fallback</button>
        <div id="fallback-test-results"></div>
    </div>

    <div class="test-section">
        <h3>üîÑ sessionStorage Fallback Test</h3>
        <p>This test temporarily disables localStorage and IndexedDB to verify fallback to sessionStorage</p>
        <button onclick="testSessionStorageFallback()">Test sessionStorage Fallback</button>
        <div id="session-test-results"></div>
    </div>

    <div class="test-section">
        <h3>‚ö†Ô∏è Complete Storage Unavailability Simulation</h3>
        <p>This test temporarily disables both storages to verify fallback to memory</p>
        <button onclick="testMemoryFallback()">Test Memory Fallback</button>
        <div id="memory-test-results"></div>
    </div>

    <script type="module">
        import { 
            safeSetItem, 
            safeGetItem, 
            safeRemoveItem,
            getStorageType, 
            getStorageInfo,
            isLocalStorageAvailable,
            isSessionStorageAvailable,
            isIndexedDBAvailable
        } from './js/helpers/localStorage.js';

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        window.safeSetItem = safeSetItem;
        window.safeGetItem = safeGetItem;
        window.safeRemoveItem = safeRemoveItem;
        window.getStorageType = getStorageType;
        window.getStorageInfo = getStorageInfo;
        window.isLocalStorageAvailable = isLocalStorageAvailable;
        window.isSessionStorageAvailable = isSessionStorageAvailable;
        window.isIndexedDBAvailable = isIndexedDBAvailable;

        // Show diagnostic information on load
        async function showDiagnosticInfo() {
            const info = await getStorageInfo();
            document.getElementById('diagnostic-info').innerHTML = `
                <strong>localStorage:</strong> ${info.localStorage.exists ? '‚úÖ Exists' : '‚ùå Does not exist'} | 
                ${info.localStorage.available ? '‚úÖ Available' : '‚ùå Unavailable'}<br>
                <strong>IndexedDB:</strong> ${info.indexedDB.exists ? '‚úÖ Exists' : '‚ùå Does not exist'} | 
                ${info.indexedDB.available ? '‚úÖ Available' : '‚ùå Unavailable'}<br>
                <strong>sessionStorage:</strong> ${info.sessionStorage.exists ? '‚úÖ Exists' : '‚ùå Does not exist'} | 
                ${info.sessionStorage.available ? '‚úÖ Available' : '‚ùå Unavailable'}<br>
                <strong>Current storage:</strong> <em>${info.currentStorage}</em>
            `;
        }

        showDiagnosticInfo();

        // Test basic operations
        window.testBasicOperations = async function() {
            const resultsDiv = document.getElementById('basic-test-results');
            resultsDiv.innerHTML = '<div class="result warning">üîÑ Testing...</div>';

            const testKey = 'test-key';
            const testValue = 'test-value-' + Date.now();

            try {
                // Write test
                const writeSuccess = await safeSetItem(testKey, testValue);
                const storageType = await getStorageType();
                
                resultsDiv.innerHTML = `<div class="result ${writeSuccess ? 'success' : 'error'}">
                    üìù Write: ${writeSuccess ? '‚úÖ Success' : '‚ùå Error'} (${storageType})
                </div>`;

                // Read test
                const readValue = await safeGetItem(testKey);
                const readSuccess = readValue === testValue;
                
                resultsDiv.innerHTML += `<div class="result ${readSuccess ? 'success' : 'error'}">
                    üìñ Read: ${readSuccess ? '‚úÖ Success' : '‚ùå Error'} (received: "${readValue}")
                </div>`;

                // Remove test
                const removeSuccess = await safeRemoveItem(testKey);
                const checkRemoval = await safeGetItem(testKey) === null;
                
                resultsDiv.innerHTML += `<div class="result ${removeSuccess && checkRemoval ? 'success' : 'error'}">
                    üóëÔ∏è Remove: ${removeSuccess && checkRemoval ? '‚úÖ Success' : '‚ùå Error'}
                </div>`;

            } catch (error) {
                resultsDiv.innerHTML += `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        };

        // Test IndexedDB fallback (localStorage disabled)
        window.testLocalStorageFallback = async function() {
            const resultsDiv = document.getElementById('fallback-test-results');
            resultsDiv.innerHTML = '<div class="result warning">üîÑ Testing IndexedDB fallback...</div>';

            // Save original localStorage
            const originalLocalStorage = window.localStorage;
            
            try {
                // Temporarily disable localStorage
                Object.defineProperty(window, 'localStorage', {
                    value: null,
                    writable: true
                });

                resultsDiv.innerHTML = `<div class="result warning">‚ö†Ô∏è localStorage temporarily disabled</div>`;

                const testKey = 'indexeddb-fallback-test';
                const testValue = 'indexedDB-fallback-' + Date.now();

                // Test operations
                const writeSuccess = await safeSetItem(testKey, testValue);
                const storageType = await getStorageType();
                
                resultsDiv.innerHTML += `<div class="result ${writeSuccess ? 'success' : 'error'}">
                    üìù Write to fallback: ${writeSuccess ? '‚úÖ Success' : '‚ùå Error'} (${storageType})
                </div>`;

                const readValue = await safeGetItem(testKey);
                const readSuccess = readValue === testValue;
                
                resultsDiv.innerHTML += `<div class="result ${readSuccess ? 'success' : 'error'}">
                    üìñ Read from fallback: ${readSuccess ? '‚úÖ Success' : '‚ùå Error'} (${storageType})
                </div>`;

                // Cleanup
                await safeRemoveItem(testKey);

            } finally {
                // Restore localStorage
                Object.defineProperty(window, 'localStorage', {
                    value: originalLocalStorage,
                    writable: true
                });
                resultsDiv.innerHTML += `<div class="result success">‚úÖ localStorage restored</div>`;
            }
        };

        // Test sessionStorage fallback (localStorage and IndexedDB disabled)
        window.testSessionStorageFallback = async function() {
            const resultsDiv = document.getElementById('session-test-results');
            resultsDiv.innerHTML = '<div class="result warning">üîÑ Testing sessionStorage fallback...</div>';

            // Save original storages
            const originalLocalStorage = window.localStorage;
            const originalIndexedDB = window.indexedDB;
            
            try {
                // Temporarily disable localStorage and IndexedDB
                Object.defineProperty(window, 'localStorage', {
                    value: null,
                    writable: true
                });
                Object.defineProperty(window, 'indexedDB', {
                    value: null,
                    writable: true
                });

                resultsDiv.innerHTML = `<div class="result warning">‚ö†Ô∏è localStorage and IndexedDB temporarily disabled</div>`;

                const testKey = 'session-fallback-test';
                const testValue = 'sessionStorage-fallback-' + Date.now();

                // Test operations
                const writeSuccess = await safeSetItem(testKey, testValue);
                const storageType = await getStorageType();
                
                resultsDiv.innerHTML += `<div class="result ${writeSuccess ? 'success' : 'error'}">
                    üìù Write to fallback: ${writeSuccess ? '‚úÖ Success' : '‚ùå Error'} (${storageType})
                </div>`;

                const readValue = await safeGetItem(testKey);
                const readSuccess = readValue === testValue;
                
                resultsDiv.innerHTML += `<div class="result ${readSuccess ? 'success' : 'error'}">
                    üìñ Read from fallback: ${readSuccess ? '‚úÖ Success' : '‚ùå Error'} (${storageType})
                </div>`;

                // Cleanup
                await safeRemoveItem(testKey);

            } finally {
                // Restore storages
                Object.defineProperty(window, 'localStorage', {
                    value: originalLocalStorage,
                    writable: true
                });
                Object.defineProperty(window, 'indexedDB', {
                    value: originalIndexedDB,
                    writable: true
                });
                resultsDiv.innerHTML += `<div class="result success">‚úÖ Storages restored</div>`;
            }
        };

        // Test memory fallback (all storages disabled)
        window.testMemoryFallback = async function() {
            const resultsDiv = document.getElementById('memory-test-results');
            resultsDiv.innerHTML = '<div class="result warning">üîÑ Testing memory fallback...</div>';

            // Save original storages
            const originalLocalStorage = window.localStorage;
            const originalSessionStorage = window.sessionStorage;
            const originalIndexedDB = window.indexedDB;
            
            try {
                // Temporarily disable all storages
                Object.defineProperty(window, 'localStorage', {
                    value: null,
                    writable: true
                });
                Object.defineProperty(window, 'sessionStorage', {
                    value: null,
                    writable: true
                });
                Object.defineProperty(window, 'indexedDB', {
                    value: null,
                    writable: true
                });

                resultsDiv.innerHTML = `<div class="result warning">‚ö†Ô∏è All storages temporarily disabled</div>`;

                const testKey = 'memory-test';
                const testValue = 'memory-fallback-' + Date.now();

                // Test operations
                const writeSuccess = await safeSetItem(testKey, testValue);
                const storageType = await getStorageType();
                
                resultsDiv.innerHTML += `<div class="result ${writeSuccess ? 'success' : 'error'}">
                    üìù Write to memory: ${writeSuccess ? '‚úÖ Success' : '‚ùå Error'} (${storageType})
                </div>`;

                const readValue = await safeGetItem(testKey);
                const readSuccess = readValue === testValue;
                
                resultsDiv.innerHTML += `<div class="result ${readSuccess ? 'success' : 'error'}">
                    üìñ Read from memory: ${readSuccess ? '‚úÖ Success' : '‚ùå Error'} (${storageType})
                </div>`;

                // Cleanup
                await safeRemoveItem(testKey);

            } finally {
                // Restore storages
                Object.defineProperty(window, 'localStorage', {
                    value: originalLocalStorage,
                    writable: true
                });
                Object.defineProperty(window, 'sessionStorage', {
                    value: originalSessionStorage,
                    writable: true
                });
                Object.defineProperty(window, 'indexedDB', {
                    value: originalIndexedDB,
                    writable: true
                });
                resultsDiv.innerHTML += `<div class="result success">‚úÖ All storages restored</div>`;
            }
        };
    </script>
</body>
</html>
